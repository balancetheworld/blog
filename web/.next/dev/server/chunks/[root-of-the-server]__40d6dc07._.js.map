{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/zyj/%E4%BB%A3%E7%A0%81%E6%96%87%E4%BB%B6%E5%A4%B9/%E6%88%91%E7%9A%84%E4%BB%A3%E7%A0%81/blog/my-blog/web/app/api/posts/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { postService } from '@/server/services/post.service'\nimport { categoryService } from '@/server/services/category.service'\nimport { commentService } from '@/server/services/comment.service'\nimport { getAuthUser } from '@/server/middleware/auth.middleware'\n\ntype SortBy = 'latest' | 'popular'\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url)\n  const admin = searchParams.get('admin') === 'true'\n  const sortBy = (searchParams.get('sortBy') as SortBy) || 'latest'\n  const categoryId = searchParams.get('categoryId') || undefined\n\n  if (admin) {\n    const user = await getAuthUser()\n    if (!user) {\n      return NextResponse.json({ error: '未授权' }, { status: 401 })\n    }\n    const posts = await postService.getAllAdmin()\n    return NextResponse.json(posts)\n  }\n\n  const posts = await postService.getAll(sortBy, categoryId)\n\n  // 添加评论数量和分类信息\n  const postsWithExtra = await Promise.all(\n    posts.map(async (post) => ({\n      ...post,\n      commentsCount: await commentService.getCount(post.id),\n      category: post.categoryId ? await categoryService.getById(post.categoryId) : undefined\n    }))\n  )\n\n  return NextResponse.json(postsWithExtra)\n}\n\nexport async function POST(request: Request) {\n  try {\n    const user = await getAuthUser()\n\n    if (!user) {\n      return NextResponse.json({ error: '未授权' }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { title, content, excerpt, tags, published, coverImage, categoryId } = body\n\n    if (!title || !content) {\n      return NextResponse.json(\n        { error: '标题和内容不能为空' },\n        { status: 400 }\n      )\n    }\n\n    // 生成 slug\n    const slug = title\n      .toLowerCase()\n      .replace(/[^a-z0-9\\u4e00-\\u9fa5]+/g, '-')\n      .replace(/^-|-$/g, '') + '-' + Date.now()\n\n    const post = await postService.create({\n      title,\n      slug,\n      content,\n      excerpt: excerpt || content.substring(0, 100) + '...',\n      tags: tags || [],\n      published: published ?? false,\n      coverImage,\n      categoryId\n    })\n\n    return NextResponse.json(post)\n  } catch (error) {\n    console.error('Create post error:', error)\n    return NextResponse.json(\n      { error: '创建文章失败' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAQO,eAAe,IAAI,OAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC,aAAa;IAC5C,MAAM,SAAS,AAAC,aAAa,GAAG,CAAC,aAAwB;IACzD,MAAM,aAAa,aAAa,GAAG,CAAC,iBAAiB;IAErD,IAAI,OAAO;QACT,MAAM,OAAO,MAAM;QACnB,IAAI,CAAC,MAAM;YACT,OAAO,gRAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAM,GAAG;gBAAE,QAAQ;YAAI;QAC3D;QACA,MAAM,QAAQ,MAAM,YAAY,WAAW;QAC3C,OAAO,gRAAY,CAAC,IAAI,CAAC;IAC3B;IAEA,MAAM,QAAQ,MAAM,YAAY,MAAM,CAAC,QAAQ;IAE/C,cAAc;IACd,MAAM,iBAAiB,MAAM,QAAQ,GAAG,CACtC,MAAM,GAAG,CAAC,OAAO,OAAS,CAAC;YACzB,GAAG,IAAI;YACP,eAAe,MAAM,eAAe,QAAQ,CAAC,KAAK,EAAE;YACpD,UAAU,KAAK,UAAU,GAAG,MAAM,gBAAgB,OAAO,CAAC,KAAK,UAAU,IAAI;QAC/E,CAAC;IAGH,OAAO,gRAAY,CAAC,IAAI,CAAC;AAC3B;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM;QAEnB,IAAI,CAAC,MAAM;YACT,OAAO,gRAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAM,GAAG;gBAAE,QAAQ;YAAI;QAC3D;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG;QAE7E,IAAI,CAAC,SAAS,CAAC,SAAS;YACtB,OAAO,gRAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAY,GACrB;gBAAE,QAAQ;YAAI;QAElB;QAEA,UAAU;QACV,MAAM,OAAO,MACV,WAAW,GACX,OAAO,CAAC,4BAA4B,KACpC,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,GAAG;QAEzC,MAAM,OAAO,MAAM,YAAY,MAAM,CAAC;YACpC;YACA;YACA;YACA,SAAS,WAAW,QAAQ,SAAS,CAAC,GAAG,OAAO;YAChD,MAAM,QAAQ,EAAE;YAChB,WAAW,aAAa;YACxB;YACA;QACF;QAEA,OAAO,gRAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gRAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAS,GAClB;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}